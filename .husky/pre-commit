#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# FAEVision Pre-Commit TypeScript Safety Hooks
# Expert: TypeScript Expert (Morgan Taylor)
# Mission: Prevent TypeScript strict mode violations from reaching repository

echo "ğŸ” FAEVision Pre-Commit Validation"
echo "ğŸ‘¨â€ğŸ’» TypeScript Expert: Conducting safety checks..."

# 1. TypeScript strict mode validation
echo "\nğŸ”¬ Running TypeScript strict mode audit..."
npx tsc --noEmit --strict
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript strict mode validation FAILED"
  echo "ğŸš¨ Fix TypeScript errors before committing"
  exit 1
fi

# 2. ESLint validation
echo "\nğŸ” Running ESLint validation..."
npx eslint src/ --ext .ts,.tsx --max-warnings 0
if [ $? -ne 0 ]; then
  echo "âŒ ESLint validation FAILED"
  echo "ğŸš¨ Fix linting errors before committing"
  exit 1
fi

# 3. Format check
echo "\nâœ¨ Checking code formatting..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting check FAILED"
  echo "ğŸ’¡ Run 'npm run format' to fix formatting"
  exit 1
fi

# 4. Quick iterator compatibility check
echo "\nğŸ”„ Checking for iterator compatibility issues..."
if grep -r "for (const .* of .*\.keys())" src/ --include="*.ts" --include="*.tsx"; then
  echo "âš ï¸  WARNING: Potential iterator compatibility issues found"
  echo "ğŸ’¡ Consider using Array.from(obj.keys()) instead"
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Safe to commit - TypeScript Expert approval granted"
