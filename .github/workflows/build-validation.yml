name: ğŸ”¬ FAEVision Build Validation Pipeline

on:
  push:
    branches: [main, develop, preview]
  pull_request:
    branches: [main, develop, preview]

jobs:
  typescript-expert-validation:
    name: ğŸ‘¨â€ğŸ’» TypeScript Expert Comprehensive Audit
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ”¬ TypeScript Strict Mode Audit
        run: |
          echo "ğŸ” Running comprehensive TypeScript strict mode audit..."
          npx tsc --noEmit --strict
          echo "âœ… TypeScript strict mode validation passed"

      - name: ğŸ” ESLint Validation
        run: |
          echo "ğŸ” Running ESLint validation..."
          npx eslint src/ --ext .ts,.tsx --max-warnings 0
          echo "âœ… ESLint validation passed"

      - name: ğŸ—„ï¸ Prisma Schema Validation
        run: |
          echo "ğŸ—„ï¸ Validating Prisma schema..."
          npx prisma validate
          npx prisma generate --dry-run
          echo "âœ… Prisma validation passed"

      - name: ğŸ”„ Iterator Compatibility Check
        run: |
          echo "ğŸ”„ Checking for iterator compatibility issues..."
          echo "Searching for potential ES2015 iteration issues..."

          # Check for problematic iterator patterns
          ITERATOR_ISSUES=0

          if grep -r "for (const .* of .*\.keys())" src/ --include="*.ts" --include="*.tsx"; then
            echo "âš ï¸ Found .keys() iteration without Array.from()"
            ITERATOR_ISSUES=1
          fi

          if grep -r "for (const .* of .*\.values())" src/ --include="*.ts" --include="*.tsx"; then
            echo "âš ï¸ Found .values() iteration without Array.from()"
            ITERATOR_ISSUES=1
          fi

          if grep -r "for (const .* of .*\.entries())" src/ --include="*.ts" --include="*.tsx"; then
            echo "âš ï¸ Found .entries() iteration without Array.from()"
            ITERATOR_ISSUES=1
          fi

          if [ $ITERATOR_ISSUES -eq 1 ]; then
            echo "âŒ Iterator compatibility issues found"
            echo "ğŸ’¡ Use Array.from() for iterator methods like .keys(), .values(), .entries()"
            exit 1
          fi

          echo "âœ… No iterator compatibility issues found"

      - name: ğŸš€ Comprehensive Build Test
        run: |
          echo "ğŸš€ Running comprehensive build test framework..."
          node scripts/comprehensive-build-test.js
          echo "âœ… Comprehensive build test passed"

      - name: ğŸ—ï¸ Next.js Production Build
        run: |
          echo "ğŸ—ï¸ Running Next.js production build (Vercel simulation)..."
          npm run build
          echo "âœ… Next.js build completed successfully"

      - name: ğŸ“Š Build Validation Report
        if: always()
        run: |
          echo "ğŸ“Š FAEVision Build Validation Report"
          echo "=================================="
          echo "âœ… TypeScript Expert Validation: COMPLETE"
          echo "âœ… All tests designed to prevent Vercel build failures"
          echo "ğŸš€ Safe to deploy to Vercel environments"

  dependency-security-audit:
    name: ğŸ”’ Security & Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ”’ NPM Security Audit
        run: |
          echo "ğŸ”’ Running NPM security audit..."
          npm audit --audit-level moderate
          echo "âœ… Security audit completed"

      - name: ğŸ“¦ Dependency Check
        run: |
          echo "ğŸ“¦ Checking for outdated dependencies..."
          npm outdated || true
          echo "âœ… Dependency check completed"
